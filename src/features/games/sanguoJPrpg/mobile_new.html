<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=750, initial-scale=0.5, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è‰²å—RPG - ç§»åŠ¨ç‰ˆ</title>
    <link rel="stylesheet" href="css/modal.css">
    <style>
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .drop-item { transition: all 0.2s; }
        .drop-item:hover { transform: scale(1.1) !important; }
        .drop-item span { font-size: 16px; margin-left: 3px; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            width: 750px; 
            height: 1334px; 
            overflow: hidden;
            background: #0a0a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: manipulation;
        }
        
        #gameContainer {
            width: 750px;
            height: 1334px;
            position: relative;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a2e 100%);
        }
        
        #gameArea {
            position: absolute;
            top: 0;
            left: 0;
            width: 750px;
            height: 1067px;
            background: #111;
            overflow: hidden;
        }
        
        #gameContent {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #uiArea {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 750px;
            height: 267px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-top: 2px solid #333;
            padding: 10px 15px;
            z-index: 600;
        }
        
        .stat-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .stat-item { flex: 1; display: flex; align-items: center; gap: 5px; }
        .stat-label { font-size: 20px; color: #888; width: 60px; }
        .meter-container { flex: 1; height: 16px; background: #333; border-radius: 8px; overflow: hidden; }
        .meter-bar { height: 100%; border-radius: 8px; transition: width 0.1s; }
        #lifeBar { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        #actBar { background: linear-gradient(90deg, #2196F3, #03A9F4); }
        #expBar { background: linear-gradient(90deg, #9C27B0, #E91E63); }
        #atkBar { background: linear-gradient(90deg, #FF5722, #FF9800); }
        #defBar { background: linear-gradient(90deg, #00BCD4, #009688); }
        #comboBar { background: linear-gradient(90deg, #FFD700, #FFA500); }
        .stat-text { font-size: 18px; color: #fff; width: 100px; text-align: right; }
        
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-top: 1px solid #333; font-size: 22px; }
        .info-item { color: #fff; }
        .info-item span { margin-right: 15px; }
        
        .btn-row { display: flex; gap: 8px; margin-top: 8px; }
        .action-btn {
            flex: 1; padding: 12px 8px; font-size: 20px; border: none; border-radius: 8px;
            background: linear-gradient(180deg, #4a4a6a, #3a3a5a); color: #fff; cursor: pointer;
        }
        .action-btn:disabled { opacity: 0.5; }
        .action-btn:active:not(:disabled) { transform: scale(0.95); }
        
        #messageArea {
            position: absolute; bottom: 275px; left: 10px; width: 280px;
            background: rgba(0,0,0,0.75); border-radius: 8px; padding: 8px 10px;
            font-size: 16px; z-index: 100; pointer-events: none;
        }
        .message-item { margin: 4px 0; }
        
        .game-block {
            position: absolute; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            overflow: hidden; transition: transform 0.1s;
        }
        .game-block:active { transform: scale(0.95); }
        .game-block.locked { filter: brightness(0.5); border: 2px dashed #666; }
        .game-block.locked::after { content: 'ğŸ”’'; position: absolute; font-size: 16px; }
        
        .progress-bar { position: absolute; bottom: 2px; left: 2px; right: 2px; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; }
        .progress-fill { height: 100%; background: #4CAF50; border-radius: 3px; transition: width 0.1s; }
        .progress-fill.complete { background: #FFD700; }
        
        .percent-text { font-size: 16px; font-weight: bold; color: #fff; text-shadow: 1px 1px 3px #000, 0 0 5px #000; text-align: center; z-index: 1; }
        
        .item-drop { position: absolute; font-size: 16px; z-index: 50; pointer-events: auto; cursor: pointer; text-shadow: 0 0 4px #000; transition: transform 0.1s; }
        .item-drop:active { transform: scale(1.2); }
        .item-drop.gold { color: #FFD700; }
        .item-drop.exp { color: #9C27B0; }
        .item-drop.key { color: #FF9800; }
        .item-drop.key2 { color: #E91E63; }
        .item-drop.neko { color: #fff; }
        
        #mapSelector { position: absolute; top: 10px; right: 10px; z-index: 200; }
        #mapSelector select { padding: 8px 12px; font-size: 18px; border-radius: 8px; background: #333; color: #fff; border: 1px solid #555; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="mapSelector">
            <select id="mapSelect" onchange="loadMap(this.value)">
                <option value="0">åŸå§‹åœ°å›¾ (æ¨è)</option>
                <option value="0b">åŸå§‹åœ°å›¾2 (æ”¹é€ ç‰ˆ)</option>
                <option value="1">åœ°å›¾1: ç»å…¸éšæœº</option>
                <option value="2">åœ°å›¾2: åŒºåŸŸåˆ’åˆ†</option>
                <option value="3">åœ°å›¾3: èºæ—‹è¿›é˜¶</option>
                <option value="4">åœ°å›¾4: è¿·å®«é€šé“</option>
                <option value="5">åœ°å›¾5: å¡”é˜²è·¯å¾„</option>
            </select>
            <button id="restartBtn" onclick="restartGame()" style="margin-left:10px;padding:5px 12px;background:#e94560;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:14px;">é‡æ–°å¼€å§‹</button>
        </div>
        
        <div id="gameArea">
            <div id="gameContent"></div>
        </div>
        
        <div id="messageArea"></div>
        
        <!-- å¼¹æ¡† -->
        <div id="modalOverlay">
            <div id="modalBox">
                <div class="modal-header">
                    <span class="modal-title" id="modalTitle">æ ‡é¢˜</span>
                    <button class="modal-close" onclick="closeModal()">âœ•</button>
                </div>
                <!-- ä¿¡æ¯åŒºä¸ŠåŠéƒ¨åˆ† -->
                <div class="modal-info-top" id="modalInfoTop"></div>
                <!-- æ€ªç‰©å¤´åƒåŒºåŸŸ - åœ¨ä¸­é—´ -->
                <div class="modal-monster" id="modalMonster">
                    <span class="monster-icon" id="monsterIcon">ğŸ‘¹</span>
                </div>
                <!-- ä¿¡æ¯åŒºä¸‹åŠéƒ¨åˆ† -->
                <div class="modal-info-bottom" id="modalInfoBottom"></div>
                <div class="modal-progress" id="modalProgress" style="display:none">
                    <div class="modal-progress-bar">
                        <div class="modal-progress-fill" id="modalProgressFill"></div>
                    </div>
                    <div class="modal-progress-text" id="modalProgressText"></div>
                </div>
                <div class="modal-buttons" id="modalButtons"></div>
                <!-- æ‰è½ç‰©å“å±‚ - è¦†ç›–æ•´ä¸ªå¼¹æ¡† -->
                <div id="modalDropsLayer"></div>
            </div>
        </div>
        
        <div id="uiArea">
            <div class="stat-row">
                <div class="stat-item">
                    <span class="stat-label">LIFE</span>
                    <div class="meter-container"><div class="meter-bar" id="lifeBar"></div></div>
                    <span class="stat-text" id="lifeText">100/100</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ACT</span>
                    <div class="meter-container"><div class="meter-bar" id="actBar"></div></div>
                    <span class="stat-text" id="actText">50/50</span>
                </div>
            </div>
            <div class="stat-row">
                <div class="stat-item">
                    <span class="stat-label">ATK</span>
                    <div class="meter-container"><div class="meter-bar" id="atkBar"></div></div>
                    <span class="stat-text" id="atkText">10/10</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">DEF</span>
                    <div class="meter-container"><div class="meter-bar" id="defBar"></div></div>
                    <span class="stat-text" id="defText">10/10</span>
                </div>
            </div>
            <div class="stat-row">
                <div class="stat-item">
                    <span class="stat-label">EXP</span>
                    <div class="meter-container"><div class="meter-bar" id="expBar"></div></div>
                    <span class="stat-text" id="expText">0/100</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">COMBO</span>
                    <div class="meter-container"><div class="meter-bar" id="comboBar"></div></div>
                    <span class="stat-text" id="comboText">0/120</span>
                </div>
            </div>
            <div class="info-row">
                <div class="info-item">
                    <span>LV: <span id="levelText">1</span></span>
                    <span>ğŸ’° <span id="goldText">0</span></span>
                    <span>ğŸ—ï¸ <span id="keyText">0</span></span>
                    <span>ğŸ” <span id="key2Text">0</span></span>
                    <span>å›å¤: <span id="rpeText">10</span></span>
                </div>
                <span id="addPText" style="color:#FFD700"></span>
            </div>
            <div class="btn-row">
                <button id="btnAddLife" class="action-btn">+ç”Ÿå‘½</button>
                <button id="btnAddAct" class="action-btn">+è¡ŒåŠ¨</button>
                <button id="btnAddRpe" class="action-btn">+å›å¤</button>
                <button id="btnAddAtk" class="action-btn">+æ”»å‡»</button>
                <button id="btnAddDef" class="action-btn">+é˜²å¾¡</button>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/saveSystem.js"></script>
    <script>
        // æ ¹æ®å­˜æ¡£æˆ–é€‰æ‹©åŠ è½½å¯¹åº”åœ°å›¾
        const saveData = SaveSystem.load();
        const savedMap = saveData ? saveData.selectedMap : (localStorage.getItem('selectedMap') || '0');
        const mapFiles = {
            '0': 'maps/data_0_åŸå§‹åœ°å›¾.js',
            '0b': 'maps/data_0b_åŸå§‹åœ°å›¾2.js',
            '1': 'maps/data_1_ç»å…¸éšæœº.js',
            '2': 'maps/data_2_åŒºåŸŸåˆ’åˆ†.js',
            '3': 'maps/data_3_èºæ—‹è¿›é˜¶.js',
            '4': 'maps/data_4_è¿·å®«é€šé“.js',
            '5': 'maps/data_5_å¡”é˜²è·¯å¾„.js'
        };
        document.write('<script src="' + mapFiles[savedMap] + '"><\/script>');
    </script>
    <script src="classes/Mission.js"></script>
    <script src="classes/Enemy.js"></script>
    <script src="classes/ItemObj.js"></script>
    <script src="classes/ShopItem.js"></script>
    <script src="classes/SpecialItems.js"></script>
    <script src="js/game.js"></script>
    <script src="js/modal.js"></script>
    
    <script>
        function loadMap(mapId) {
            // åˆ‡æ¢åœ°å›¾æ—¶ä¿å­˜å½“å‰ç©å®¶æ•°æ®
            if (window.game) {
                SaveSystem.save(window.game);
            }
            localStorage.setItem('selectedMap', mapId);
            location.reload();
        }
        
        function restartGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†è¢«æ¸…é™¤ï¼')) {
                SaveSystem.deleteSave();
                localStorage.removeItem('selectedMap');
                location.reload();
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®åœ°å›¾é€‰æ‹©å™¨
            const currentMap = saveData ? saveData.selectedMap : (localStorage.getItem('selectedMap') || '0');
            document.getElementById('mapSelect').value = currentMap;
            
            // åŠ è½½å­˜æ¡£æ•°æ®
            if (saveData && window.game) {
                setTimeout(() => {
                    SaveSystem.applyPlayerData(window.game, saveData.player);
                    SaveSystem.applyMapState(window.game, saveData.mapState);
                    window.game.disp();
                    console.log('å­˜æ¡£å·²æ¢å¤');
                }, 100);
            }
        });
        
        // å®šæœŸè‡ªåŠ¨ä¿å­˜
        setInterval(() => {
            if (window.game) {
                SaveSystem.save(window.game);
            }
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
        
        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            if (window.game) {
                SaveSystem.save(window.game);
            }
        });
    </script>
</body>
</html>
