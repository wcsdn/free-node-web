# 色块RPG游戏

从 Egret 引擎重构为纯 HTML/CSS/JavaScript 的放置类RPG游戏。

---

## 游戏概述

这是一款点击式放置RPG游戏。游戏界面由不同颜色的色块组成，每种颜色代表不同的功能。玩家通过点击色块来执行任务、战斗、购物等操作，逐步提升角色属性，最终击败Boss。

---

## 核心属性系统

### 基础属性

| 属性 | 初始值 | 上限 | 作用 |
|------|--------|------|------|
| LIFE (生命) | 100 | 可提升至200+ | 生命值归零后无法行动，ATK/DEF归零 |
| ACT (行动力) | 50 | 可提升至200 | 执行任务消耗，不足则任务失败 |
| ATK (攻击力) | 10 | 可提升 | 对敌人造成伤害的基础值 |
| DEF (防御力) | 10 | 上限300 | 减少受到的伤害 |
| RPE (回复力) | 10 | 可提升 | 影响所有属性的自动恢复速度 |
| EXP (经验值) | 0 | 100+(lv-1)² | 满后升级 |
| LV (等级) | 1 | 无上限 | 升级获得3点属性点 |
| GOLD (金币) | 0 | 无上限 | 购买物品的货币 |

### 自动恢复机制

游戏每16ms执行一次恢复计算：
- **LIFE恢复**: `0.004 + RPE × 0.002` 每帧
- **ACT恢复**: `0.06 + RPE × 0.01` 每帧
- **ATK恢复**: `0.03 + RPE × 0.01` 每帧（恢复至上限）
- **DEF恢复**: `0.03 + RPE × 0.01` 每帧（恢复至上限）

### 升级系统

- 经验值达到上限时升级
- 升级公式：`exp_max = 100 + (lv - 1)²`
- 升级奖励：
  - 获得 **3点属性点**
  - LIFE和ACT完全恢复
  - 生命回复商店价格重置

### 属性点分配

升级获得的属性点可分配到：
- **LIFE**: 生命上限+1，当前生命+1
- **ACT**: 行动上限+1，当前行动+1
- **RPE**: 回复力+1
- **ATK**: 攻击上限+1，当前攻击+1
- **DEF**: 防御上限+1，当前防御+1

---

## 钥匙系统

### 普通钥匙 🔑

- **获取方式**: 击败敌人（每个敌人掉落1-4把，数量=`面积/1000 % 4 + 1`）
- **用途**: 解锁大型任务、敌人、商店（面积>1000或>1500的色块）
- **购买**: 钥匙商店400金币/把

### 高级钥匙 🔑2

- **获取方式**: 击败敌人（每个敌人固定掉落1把）
- **用途**: 解锁特殊功能商店（生命回复、ACT上限、LIFE上限、属性点商店）

---

## 色块功能详解

### 🔵 蓝色 - 任务 (Mission)

**机制**:
- 消耗ACT执行任务，消耗量 = `面积 × 0.01`
- 每次执行增加进度 `10 + 随机(0-3)`
- 进度满后任务完成，获得1点属性点
- 完成后可重复执行（征收模式），只获得金币

**奖励计算**:
- 金币: `面积 × 0.03 × (1+随机) × 2`（完成后×1.5）
- 经验: `面积 × 0.1 × (1+随机) × 2`（完成后×1.5，征收模式无经验）
- 3%概率掉落随机猫

**锁定条件**: 面积 > 1000 需要普通钥匙解锁

### 🔴 红色 - 敌人 (Enemy)

**战斗机制**:
1. 点击攻击敌人
2. 伤害计算：
   - 标准: `ATK × (1 - 距离/2600) × 0.5`
   - 高瘦型: `ATK × 0.25 + 随机(-5~5)`
3. 敌人反击（15帧后）: `20 + (高+宽)/2`
4. 敌人会缓慢回血: `(y-70) × 0.0001 × (生命上限/100) + RPE × 0.01`

**伤害减免公式**:
```
实际伤害 = 敌人攻击 × 0.5 × (1 - DEF/300)
最小伤害 = 5 + 随机(0-10)
```

**奖励**:
- 金币: `面积 / 10`
- 经验: `面积 / 15`
- 普通钥匙: `面积/1000 % 4 + 1` 把
- 高级钥匙: 1把
- 25%概率掉落随机猫

**锁定条件**: 面积 > 1500 需要普通钥匙解锁

### 🟣 洋红色 - ATK商店

**机制**:
- 价格: `面积/10 + (高-30)² + (高-30)×45`
- 加成: `面积/100 × 0.45 × (1 - 购买次数×0.05)`
- 每个最多购买9次，效果递减
- 面积>1000需要普通钥匙解锁

### 🔵 青色 - DEF商店

**机制**:
- 价格: `面积/10 + (宽-30)² - (高-30)×10`
- 加成: `面积/100 × 0.5 × (1 - 购买次数×0.05)`
- 每个最多购买9次，效果递减
- 面积>1000需要普通钥匙解锁

### 🟢 绿色 - 生命回复商店

**机制**:
- 初始价格: `100 + 等级×20`
- 每次使用后价格×1.5（上限3600）
- 回复100点生命
- 升级时价格重置
- 需要高级钥匙解锁

### 🟠 橙色 - ACT上限商店

**机制**:
- 初始价格: 100
- 每次购买后价格×1.05
- ACT上限+1（最高200）
- 需要高级钥匙解锁

### 🔴 粉色 - LIFE上限商店

**机制**:
- 初始价格: 100
- 每次购买后价格×1.05
- LIFE上限+1（最高200）
- 需要高级钥匙解锁

### 🟣 深紫色 - 属性点商店

**机制**:
- 价格: 200金币
- 购买获得1点属性点
- 需要高级钥匙解锁

### ⬛ 灰色 - 钥匙商店

**机制**:
- 价格: 400金币
- 购买获得1把普通钥匙
- 无需解锁

### 🟤 棕色 - 宝箱 (成就奖励)

初始隐藏，完成对应成就后激活：

| 宝箱 | 触发条件 | 奖励 |
|------|----------|------|
| n1 | 全任务完成 | LIFE上限+20 |
| n2 | 全敌讨伐 | RPE×2 |
| n3 | 全物品购买 | ACT上限+20 |
| n4 | 最大连击(120) | 200金币×当前等级 |
| n5 | 收集9只猫 | ATK上限×2 |

### 🟣 紫色 - 老虎机 (40级解锁)

**机制**:
- 花费10金币启动
- 点击3次停止转轮
- 三个相同符号获奖

**奖励表**:
| 符号 | 奖励 |
|------|------|
| $$$ | 1600金币 (8×200) |
| @@@ | 200经验 (10×20) |
| 777 | 15540金币 (20×777) |
| *** | 9600金币 (12×800) |

### 🔴 深红色 - Boss

**解锁条件**: 完成全部任务 + 击败全部敌人

**战斗机制**:
- 生命值: 240 (5×48)
- 伤害计算: `max(1, (ATK-200) × 0.2)` —— **需要200+攻击力才能有效伤害**
- Boss反击: `100 - Boss当前生命/4`
- Boss回血: `(生命上限-当前生命) × 0.002 + 0.001`

**击败奖励**:
- 10000金币 (10×1000)
- 6000经验 (6×1000)
- 第9只猫

---

## 连击系统 (Combo)

**机制**:
- 获得任何资源（金币/经验/钥匙/猫）时触发
- 连击计时器: 45帧（约0.72秒）
- 计时器归零前再次获得资源，连击+1
- 连击达到120触发成就

---

## 掉落物品系统

**物品类型**:
- 💰 金币 - 自动收集（30帧后闪烁消失）
- ⭐ 经验 - 自动收集（30帧后闪烁消失）
- 🔑 普通钥匙 - 需手动收集（不会消失）
- 🔑 高级钥匙 - 需手动收集（不会消失）
- 🐱 猫 - 需手动收集（不会消失）

**收集方式**: 鼠标悬停或点击

---

## 成就系统

| 成就 | 条件 | 效果 |
|------|------|------|
| 全任务完成 | 完成所有57个任务 | 激活宝箱n1，解锁Boss条件之一 |
| 全敌讨伐 | 击败所有29个敌人 | 激活宝箱n2，解锁Boss条件之一 |
| 全物品购买 | 首次购买所有9个商店物品 | 激活宝箱n3 |
| 最大连击 | 连击数达到120 | 激活宝箱n4 |
| NEKOGAMES | 收集全部9只猫 | 激活宝箱n5 |

---

## 游戏流程建议

### 前期 (1-10级)
1. 点击小型蓝色任务块积累金币和经验
2. 升级后优先加RPE（加快所有恢复速度）
3. 击败小型红色敌人获取钥匙
4. 用钥匙解锁更大的任务和敌人

### 中期 (10-30级)
1. 购买ATK/DEF商店物品提升战斗力
2. 用高级钥匙解锁特殊商店
3. 完成成就解锁宝箱奖励
4. 注意保持连击数，争取达成120连击成就

### 后期 (30级+)
1. 40级解锁老虎机，可以赌博获取大量金币
2. 完成全任务+全敌人解锁Boss
3. 攻击力需达到200+才能有效伤害Boss
4. 收集全部9只猫解锁最终成就

---

## 技术信息

### 运行方式
```bash
python -m http.server 3000
```
访问 http://localhost:3000

### 技术栈
HTML5 + CSS3 + JavaScript (ES6+)，无引擎依赖

### 游戏数据
- 任务数量: 57个
- 敌人数量: 29个
- 商店物品: 9个 (ATK×4, DEF×5)
- 特殊商店: 4个
- 宝箱: 5个
- 猫: 9只

---

## 地图工具

### 地图生成器 (tools/generateMaps.js)

生成5种风格的随机地图，适配750×1067移动端屏幕。

```bash
cd tools
node generateMaps.js
```

**地图风格**:
1. 经典随机 - 随机分布的色块
2. 区域划分 - 按类型分区域放置
3. 螺旋进阶 - 从外向内螺旋布局
4. 迷宫通道 - 迷宫式路径布局
5. 塔防路径 - 沿路径分布

### 原始地图布局工具 (tools/relayoutMap.js)

将原始地图(800×630)的元素等比缩放适配到移动端区域(750×1067)。

```bash
node tools/relayoutMap.js
```

**算法说明**:

1. **计算原始内容边界**: 扫描所有元素，找出实际内容的最小/最大坐标
   - 原始边界: (49,79) - (801,605)
   - 内容尺寸: 752 × 526

2. **计算缩放比例**: 
   - 目标区域: 750 × 1067 (留20像素边距后为710 × 1027)
   - X缩放 = 710 / 752 ≈ 0.944
   - Y缩放 = 1027 / 526 ≈ 1.953

3. **坐标转换**:
   ```
   newX = padding + (原始X - minX) × scaleX
   newY = padding + (原始Y - minY) × scaleY
   newW = 原始W × scaleX
   newH = 原始H × scaleY
   ```

4. **输出**: 生成 `maps/data_0b_原始地图2.js`，包含缩放后的所有元素数据
