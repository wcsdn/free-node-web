# 建筑建造功能测试指南

## 测试前准备

### 1. 确认后端运行
```bash
# 检查 wrangler 是否在运行
lsof -ti:8788

# 如果没有运行，启动它
cd workers/ghost-game
npm run build
wrangler dev --local
```

### 2. 确认前端运行
```bash
# 检查前端是否在运行
lsof -ti:5173

# 刷新浏览器页面以加载新代码
```

### 3. 确认测试数据
- 钱包地址: `0x1234567890abcdef1234567890abcdef12345678`
- 资源: 10万银两、10万粮食、1万人口
- 聚义厅: 11级（位置 10）

---

## 测试步骤

### 测试 1: 点击空地显示建造面板

**步骤**:
1. 打开浏览器，访问 `http://localhost:5173`
2. 进入游戏内政页面
3. 点击地图上的空地（如位置 1、2、3 等）

**预期结果**:
- 弹出建造面板
- 显示标题：【选择建筑】位置 X
- 显示可建造的建筑列表（根据 DependPos 筛选）
- 每个建筑显示：名称、图标、等级、所需资源

**检查点**:
- [ ] 弹窗正常显示
- [ ] 建筑列表不为空
- [ ] 建筑图标正确显示
- [ ] 资源需求正确显示

**调试**:
如果没有弹窗，检查浏览器控制台：
```javascript
// 检查全局函数是否存在
console.log(window.OpenBuildingSelect);

// 手动测试
window.OpenBuildingSelect(1, { money: 10000, food: 10000, population: 500 }, () => {
  console.log('建造成功回调');
});
```

---

### 测试 2: 选择建筑

**步骤**:
1. 在建造面板中点击不同的建筑
2. 观察选中状态和详细信息

**预期结果**:
- 点击建筑后，该建筑卡片高亮显示（绿色边框）
- 下方显示该建筑的详细资源需求
- 显示当前拥有的资源和是否足够

**检查点**:
- [ ] 选中状态正确切换
- [ ] 详细信息正确显示
- [ ] 资源对比正确（绿色=足够，红色=不足）

---

### 测试 3: 资源不足提示

**步骤**:
1. 选择一个资源需求很高的建筑（如果有）
2. 点击"建造"按钮

**预期结果**:
- 如果资源不足，显示错误提示
- 提示信息明确指出哪种资源不足

**检查点**:
- [ ] 资源不足时无法建造
- [ ] 错误提示清晰明确

---

### 测试 4: 成功建造建筑

**步骤**:
1. 选择一个资源充足的建筑
2. 点击"建造"按钮
3. 等待建造完成

**预期结果**:
- 显示"建造成功"提示
- 弹窗自动关闭
- 建筑出现在地图上对应位置
- 右侧建筑列表更新
- 资源正确扣除

**检查点**:
- [ ] 建造成功提示显示
- [ ] 弹窗自动关闭
- [ ] 建筑图标出现在地图上
- [ ] 建筑列表更新
- [ ] 资源正确扣除

**后端日志检查**:
```
[wrangler:info] POST /api/game/city/1/available-buildings/1 200 OK
[wrangler:info] POST /api/game/city/1/build-building 200 OK
[wrangler:info] POST /api/game/city/building-list/1 200 OK
```

---

### 测试 5: 建造后再次点击

**步骤**:
1. 点击刚才建造的建筑所在位置
2. 观察弹窗内容

**预期结果**:
- 显示建筑详情面板（不是建造面板）
- 显示建筑名称、等级、效果值
- 显示升级所需资源
- 有"升级"和"拆除"按钮

**检查点**:
- [ ] 显示建筑详情（不是建造面板）
- [ ] 建筑信息正确
- [ ] 可以升级或拆除

---

### 测试 6: 不同位置的建筑

**步骤**:
1. 点击不同位置的空地（位置 1-16）
2. 观察可建造的建筑列表是否不同

**预期结果**:
- 不同位置显示不同的可建造建筑
- 根据 `DependPos` 字段筛选

**检查点**:
- [ ] 位置 10: 只能建聚义厅
- [ ] 位置 6: 显示 DependPos=6 的建筑
- [ ] 位置 3: 显示 DependPos=3 的建筑

**参考数据**:
```json
{
  "ID": 1, "Name": "聚义厅", "DependPos": 10
  "ID": 2, "Name": "民心设施", "DependPos": 6
  "ID": 7, "Name": "银库", "DependPos": 3
}
```

---

## 常见问题排查

### 问题 1: 点击空地没有反应

**可能原因**:
1. 前端代码未刷新
2. 全局函数未挂载
3. JavaScript 错误

**排查步骤**:
```javascript
// 1. 检查控制台是否有错误
// 2. 检查全局函数
console.log(window.OpenBuildingSelect);

// 3. 手动触发
window.OpenBuildingSelect(1, {}, () => {});
```

### 问题 2: 弹窗显示"该位置暂无可建造的建筑"

**可能原因**:
1. 该位置没有对应的建筑配置
2. 前置条件不满足（聚义厅等级不够）

**排查步骤**:
```bash
# 检查后端日志
# 查看 available-buildings API 返回的数据

# 检查数据库
wrangler d1 execute ghost-game-db --local --command "SELECT * FROM buildings WHERE city_id = 1"
```

### 问题 3: 建造失败

**可能原因**:
1. 资源不足
2. 位置已有建筑
3. 后端验证失败

**排查步骤**:
```bash
# 检查后端日志中的错误信息
# 查看 build-building API 的响应

# 检查资源
wrangler d1 execute ghost-game-db --local --command "SELECT money, food, population FROM cities WHERE id = 1"
```

### 问题 4: 建造成功但建筑未显示

**可能原因**:
1. 建筑列表未刷新
2. 图标路径错误
3. 位置坐标错误

**排查步骤**:
```javascript
// 检查建筑列表
console.log(buildings);

// 手动刷新
loadBuildings();
```

---

## 测试数据

### 可用的空地位置
- 位置 1-16（除了已有建筑的位置）
- 当前已有建筑：位置 10（聚义厅）、位置 6（民心设施）、位置 3（银库）

### 测试用建筑配置
```json
{
  "聚义厅": { "DependPos": 10, "CostMoney": 110, "CostFood": 80, "CostMen": 8 },
  "民心设施": { "DependPos": 6, "CostMoney": 100, "CostFood": 70, "CostMen": 5 },
  "银库": { "DependPos": 3, "CostMoney": 120, "CostFood": 90, "CostMen": 10 }
}
```

---

## 成功标准

### 功能完整性
- [x] 后端 API 实现
- [x] 前端 API 调用
- [x] 弹窗组件集成
- [x] 空地点击逻辑
- [ ] 建造流程完整（待测试）

### 用户体验
- [ ] 点击响应流畅
- [ ] 错误提示清晰
- [ ] 建造成功有反馈
- [ ] 资源显示准确

### 代码质量
- [x] 类型定义完整
- [x] 错误处理完善
- [x] 代码注释清晰
- [x] 遵循原有代码风格

---

**测试时间**: 2026-02-05
**测试人员**: 开发团队
**状态**: 待测试
