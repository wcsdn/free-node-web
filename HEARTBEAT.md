# HEARTBEAT.md - 心跳检查与任务监控

**用途**: 确保 AI 任务不会卡住或无限期运行

---

## 🎯 触发条件

当任务执行时间超过 **30分钟** 无响应时，触发心跳检查。

## 🚨 卡住检测

**自动检测以下情况**:
1. 命令执行超时 (> 5分钟)
2. 编译过程停滞 (> 10分钟)
3. 部署过程卡住 (> 15分钟)
4. 无限循环或死锁

## 🔄 自动恢复策略

### 级别 1: 轻度卡住 (5-10分钟)
- **症状**: 命令输出停滞，无错误
- **动作**: 发送系统事件通知
- **恢复**: 继续监控，等待完成

### 级别 2: 中度卡住 (10-30分钟)
- **症状**: 命令无响应，可能死锁
- **动作**: 
  - 发送紧急通知
  - 终止无响应进程
  - 重试操作
- **恢复**: 从上一个检查点继续

### 级别 3: 严重卡住 (> 30分钟)
- **症状**: 进程完全无响应
- **动作**:
  - 强制终止所有相关进程
  - 保存当前状态到 EXECUTION_REPORT.md
  - 发送完整状态报告
- **恢复**: 人工介入或完全回滚

## 📊 检查清单 (自动执行)

每 **15分钟** 检查以下项目：

- [ ] **Git 状态**: 是否有未提交的更改？
- [ ] **编译状态**: 前端/Workers 是否编译成功？
- [ ] **部署状态**: 是否部署到生产环境？
- [ ] **数据库**: D1 是否正常？
- [ ] **API 健康**: Worker API 是否可访问？

## 🎬 手动触发心跳

如果任务看起来卡住，运行：
```bash
# 检查所有后台进程
ps aux | grep node

# 检查 OpenClaw 状态
openclaw status

# 检查最近部署
wrangler deployments list --name ghost-game
```

## 🔧 配置示例

```json
{
  "heartbeatIntervalMs": 900000,  // 15分钟
  "stuckThresholdMs": 1800000,     // 30分钟
  "notification": {
    "email": true,
    "webhook": true
  }
}
```

## 📝 卡住时的处理步骤

1. **保存现场**: 
   - 保存 EXECUTION_REPORT.md
   - 保存 Git 状态快照

2. **终止进程**:
   - kill 掉无响应进程
   - 清理临时文件

3. **恢复策略**:
   - 从上一个检查点继续
   - 或回滚到稳定版本

4. **通知用户**:
   - 发送状态报告
   - 说明卡住原因
   - 提供恢复建议

---

**最后更新**: 2026-02-07
